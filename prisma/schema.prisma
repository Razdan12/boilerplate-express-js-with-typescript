generator client {
    provider = "prisma-client-js"
    output   = "./generated/client"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

model User {
    id       String  @id @default(uuid())
    fullName String  @map("full_name")
    email    String  @unique
    password String
    picture  String?
    isActive Boolean @default(false) @map("is_active")

    roles      UserRole[]
    candidates Candidate[]
    bills      Bill[]
    payments   Payment[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("users")
}

model UserRole {
    id       String  @id @default(uuid())
    roleId   String  @map("role_id")
    userId   String  @map("user_id")
    isActive Boolean @default(true) @map("is_active")

    role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([roleId, userId])
    @@map("user_roles")
}

model Role {
    id       String  @id @default(uuid())
    code     String  @unique
    name     String
    isActive Boolean @default(true) @map("is_active")

    users UserRole[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("roles")
}

model Season {
    id        String   @id @default(uuid())
    title     String   @unique @map("title")
    slug      String   @unique @map("slug")
    startDate DateTime @map("start_date")
    endDate   DateTime @map("end_date")
    isActive  Boolean  @default(false) @map("is_active")

    candidates Candidate[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("seasons")
}

model Candidate {
    id          String    @id @default(uuid())
    seasonId    String    @map("season_id")
    userId      String?   @map("user_id") @db.VarChar(36)
    status      String    @default("enroll") @map("status") // enroll, passed_test, failed_test, walk_out, accepted, rejected
    fullName    String    @map("full_name")
    nickName    String?   @map("nick_name")
    birthDate   DateTime? @map("birth_date")
    birthPlace  String?   @map("birth_place")
    gender      String?   @map("gender") // male, female
    eduLevel    String    @map("edu_level") // TK, SD, SM
    eduClass    String    @map("edu_class") // A, B, 1, 2, 3, 4, 5, 6, 7, 8, 9
    studentType String?   @map("student_type") // R, ABKTP, ABKDP
    photoPath   String?   @map("photo_path")

    season        Season         @relation(fields: [seasonId], references: [id], onDelete: Restrict)
    user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
    schedules     Schedule[]
    attachments   Attachment[]
    announcements Announcement[]
    formResponses FormResponse[]
    bills         Bill[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@unique([seasonId, fullName])
    @@map("candidates")
}

model Schedule {
    id          String   @id @default(uuid())
    candidateId String   @map("candidate_id")
    title       String   @map("title")
    startDate   DateTime @map("start_date")
    endDate     DateTime @map("end_date")
    remark      String?  @map("remark") @db.Text

    candidate   Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
    attachments Attachment[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("schedules")
}

model Attachment {
    id          Int     @id @default(autoincrement())
    candidateId String  @map("candidate_id")
    scheduleId  String? @map("schedule_id")

    title    String  @map("title")
    remark   String? @map("remark")
    filePath String  @map("file_path")

    candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
    schedule  Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("schedule_attachments")
}

model Announcement {
    id    String  @id @default(uuid())
    type  String  @map("type") // success, warning, error, info
    title String  @map("title")
    desc  String? @map("desc") @db.Text

    candidates Candidate[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("announcement")
}

model Form {
    id       String  @id @default(uuid())
    title    String  @map("title")
    isActive Boolean @default(true) @map("is_active")

    pages     FormPage[]
    responses FormResponse[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("forms")
}

model FormPage {
    id               String  @id @default(uuid())
    formId           String  @map("form_id")
    title            String  @map("title")
    order            Int     @map("order")
    view             String  @default("list") @map("view") // list, table, variants
    variants         String? @map("variants") // string[] separated by "|"
    variantsRequired String? @map("variants_required") // (bool as string)[] separated by "|"

    form      Form           @relation(fields: [formId], references: [id], onDelete: Cascade)
    questions FormQuestion[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@unique([formId, title])
    @@map("form_pages")
}

model FormQuestion {
    id       String   @id @default(uuid())
    parentId String?  @map("parent_id")
    pageId   String   @map("page_id")
    order    Int      @map("order") // order inside page
    name     String   @map("name")
    label    String   @map("label") @db.Text
    type     String   @map("type") // text, bool, number, check, radio, select, file, order, region
    hint     String?  @map("hint")
    rules    Json?    @map("rules")
    required Boolean? @map("required")

    page     FormPage             @relation(fields: [pageId], references: [id], onDelete: Cascade)
    parent   FormQuestion?        @relation("FormQuestionParent", fields: [parentId], references: [id], onDelete: Cascade)
    children FormQuestion[]       @relation("FormQuestionParent")
    options  FormQuestionOption[]
    answers  FormResponseAnswer[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@unique([pageId, name])
    @@map("form_questions")
}

model FormQuestionOption {
    id          Int      @id @default(autoincrement())
    questionId  String   @map("question_id")
    label       String   @map("label") @db.Text
    value       String   @map("value") @db.Text
    isFreeValue Boolean? @map("is_free_value")

    question FormQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("form_question_options")
}

model FormResponse {
    id          String @id @default(uuid())
    formId      String @map("form_id")
    candidateId String @map("candidate_id")
    status      String @default("draft") @map("status") // draft, submitted

    form      Form                 @relation(fields: [formId], references: [id], onDelete: Restrict)
    candidate Candidate            @relation(fields: [candidateId], references: [id], onDelete: Cascade)
    answers   FormResponseAnswer[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@unique([formId, candidateId])
    @@map("form_responses")
}

model FormResponseAnswer {
    id         String    @id @default(uuid())
    responseId String    @map("response_id")
    questionId String    @map("question_id")
    variant    String?   @map("variant")
    subVariant String?   @map("sub_variant")
    ansDate    DateTime? @map("ans_date")
    ansBool    Boolean?  @map("ans_bool")
    ansText    String?   @map("ans_text") @db.Text
    ansNumber  Float?    @map("ans_number")

    response FormResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
    question FormQuestion @relation(fields: [questionId], references: [id], onDelete: Restrict)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("form_response_answers")
}

model PaymentRef {
    id          String  @id @default(uuid())
    type        String  @map("type") // initial_payment, full_payment, discount
    title       String  @map("title")
    eduLevel    String  @map("edu_level") // same as candidate.eduLevel
    studentType String  @map("student_type") // same as candidate.edul
    amount      Float   @map("amount")
    isActive    Boolean @default(true) @map("is_active")

    bills Bill[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@unique([type, title, eduLevel, studentType])
    @@map("payment_refs")
}

model Bill {
    id          String  @id @default(uuid())
    paymentId   String? @map("payment_id")
    userId      String? @map("user_id")
    candidateId String? @map("candidate_id")
    refId       String? @map("ref_id")
    fullName    String  @map("full_name")
    email       String  @map("email")
    title       String  @map("title")
    desc        String? @map("desc")
    quantity    Int     @default(1) @map("quantity")
    amount      Float   @map("amount")

    user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
    candidate Candidate?  @relation(fields: [candidateId], references: [id], onDelete: SetNull)
    ref       PaymentRef? @relation(fields: [refId], references: [id], onDelete: SetNull)
    payment   Payment?    @relation(fields: [paymentId], references: [id], onDelete: Restrict)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("bills")
}

model Payment {
    id         String    @id @default(uuid())
    userId     String?   @map("user_id")
    title      String    @map("title")
    status     String    @default("pending") @map("status") // pending, success, failed
    amount     Float     @map("amount")
    method     String    @map("method") // manual_transfer
    expireDate DateTime? @map("expire_date")
    proofPath  String?   @map("proof_path")

    user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
    bills Bill[]

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

    @@map("payments")
}
